<view class="page {{themeClass}}">
  <scroll-view class="page-content" scroll-y enable-flex>
    <view class="page-inner with-tabbar {{transitionClass}}" wx:if="{{form}}">
      <view class="top-bar">
        <text class="page-title">菜单设置</text>
      </view>
      <view class="card section-card">
        <view class="section-header">
          <text class="section-title">基础信息</text>
          <text class="section-desc">展示给顾客的菜单名称与简介</text>
        </view>
        <view class="form-field">
          <label>菜单名称</label>
          <input
            value="{{form.name}}"
            data-field="name"
            bindinput="onInput"
            placeholder="请输入菜单名称"
          />
        </view>
        <view class="form-field">
          <label>菜单描述</label>
          <textarea
            value="{{form.description}}"
            data-field="description"
            bindinput="onInput"
            placeholder="用于介绍菜单定位、特色等"
          ></textarea>
        </view>
        <view class="form-field cover-field">
          <label>菜单主图</label>
          <view class="cover-wrapper">
            <view
              class="cover-preview {{form.coverImage ? 'cover-preview--filled' : ''}}"
              bindtap="onPreviewCover"
            >
              <image
                wx:if="{{form.coverImage}}"
                src="{{form.coverImage}}"
                mode="aspectFill"
              ></image>
              <view wx:else class="cover-placeholder">推荐尺寸 750×400，点击可预览</view>
            </view>
            <view class="cover-actions">
              <button
                class="pill-btn"
                size="mini"
                loading="{{coverUploading}}"
                bindtap="onChooseCover"
              >
                上传图片
              </button>
              <button
                class="pill-btn ghost"
                size="mini"
                bindtap="onClearCover"
                wx:if="{{form.coverImage}}"
              >
                清除
              </button>
            </view>
          </view>
          <input
            class="cover-input"
            value="{{form.coverImage}}"
            data-field="coverImage"
            bindinput="onInput"
            placeholder="可粘贴图片链接或云存储 fileID"
          />
        </view>
      </view>
      <view class="card section-card">
        <view class="section-header">
          <text class="section-title">主题设置</text>
          <text class="section-desc">切换管理端与顾客端的配色方案</text>
        </view>
        <theme-picker
          themes="{{themeOptions}}"
          value="{{form.theme}}"
          label="主题选择"
          bind:change="onThemeChange"
        ></theme-picker>
      </view>
      <view class="card section-card category-card">
        <view class="category-header">
          <view class="section-header">
            <text class="section-title">菜品分类</text>
            <text class="section-desc">管理菜单左侧分类顺序与名称</text>
          </view>
          <button class="icon-btn" size="mini" bindtap="onAddCategory">新增分类</button>
        </view>
        <view class="category-list" wx:if="{{categories.length}}">
          <block wx:for="{{categories}}" wx:key="id" wx:for-item="category" wx:for-index="index">
            <view class="category-row">
              <view class="category-info">
                <text class="category-name">{{category.name}}</text>
              </view>
              <view class="category-actions">
                <button class="pill-btn ghost" size="mini" data-id="{{category.id}}" bindtap="onRenameCategory">编辑</button>
                <button
                  class="pill-btn ghost"
                  size="mini"
                  data-id="{{category.id}}"
                  bindtap="onDeleteCategory"
                  disabled="{{category.id === menu.defaultCategoryId}}"
                >
                  删除
                </button>
                <button
                  class="pill-btn ghost"
                  size="mini"
                  data-id="{{category.id}}"
                  data-direction="up"
                  bindtap="onMoveCategory"
                  disabled="{{index === 0}}"
                >
                  上移
                </button>
                <button
                  class="pill-btn ghost"
                  size="mini"
                  data-id="{{category.id}}"
                  data-direction="down"
                  bindtap="onMoveCategory"
                  disabled="{{index === categories.length - 1}}"
                >
                  下移
                </button>
              </view>
            </view>
          </block>
        </view>
        <view class="empty" wx:else>暂无分类</view>
      </view>
      <view class="card section-card option-section">
        <view class="option-heading">
          <view class="section-header">
            <text class="section-title">自定义选项</text>
            <text class="section-desc">维护可复用的菜品选项，如辣度、份量等</text>
          </view>
          <button class="icon-btn" size="mini" bindtap="onStartCreateOption">新建选项</button>
        </view>
        <view class="option-form">
          <view class="form-field">
            <label>选项名称</label>
            <input
              placeholder="例如 辣度"
              value="{{optionForm.name}}"
              data-field="name"
              bindinput="onOptionFormInput"
            />
          </view>
          <view class="form-field">
            <label>添加可选项</label>
            <view class="add-choice-row">
              <input
                placeholder="输入选项名称"
                value="{{optionChoiceInput}}"
                bindinput="onOptionChoiceInput"
              />
              <button class="pill-btn" size="mini" bindtap="onAddOptionChoice">添加</button>
            </view>
          </view>
          <radio-group
            class="choices-list"
            bindchange="onOptionDefaultChoiceChange"
            value="{{optionForm.defaultChoice}}"
          >
            <block wx:for="{{optionForm.choices}}" wx:key="value" wx:for-item="choice">
              <view class="choice-item {{optionForm.defaultChoice === choice.value ? 'is-default' : ''}}">
                <view
                  class="choice-main"
                  data-value="{{choice.value}}"
                  bindtap="onSelectOptionDefaultChoice"
                >
                  <radio value="{{choice.value}}" checked="{{optionForm.defaultChoice === choice.value}}"></radio>
                  <text class="choice-label">{{choice.label}}</text>
                  <text class="default-tag" wx:if="{{optionForm.defaultChoice === choice.value}}">默认</text>
                </view>
                <button
                  class="pill-btn"
                  size="mini"
                  data-value="{{choice.value}}"
                  bindtap="onRemoveOptionChoice"
                >移除</button>
              </view>
            </block>
          </radio-group>
          <view class="form-actions option-form-actions">
            <button class="option-btn option-btn--primary" bindtap="onSaveOption">保存选项</button>
            <button class="option-btn option-btn--secondary" bindtap="onStartCreateOption">重置</button>
          </view>
        </view>
        <view class="option-list-card">
          <view class="list-header">
            <text class="list-title">现有选项</text>
          </view>
          <view class="options-list" wx:if="{{options.length}}">
            <block wx:for="{{options}}" wx:key="id" wx:for-item="option">
              <view class="option-card">
                <view class="option-card-header">
                  <text class="option-name">{{option.name}}</text>
                </view>
                <view class="option-card-body" wx:if="{{option.choices && option.choices.length}}">
                  <block wx:for="{{option.choices}}" wx:key="value" wx:for-item="choice">
                    <text class="choice-tag">{{choice.label}}</text>
                  </block>
                </view>
                <view class="option-card-footer">
                  <button class="pill-btn" size="mini" data-id="{{option.id}}" bindtap="onEditOption">编辑</button>
                  <button class="pill-btn" size="mini" data-id="{{option.id}}" bindtap="onDeleteOption">删除</button>
                </view>
              </view>
            </block>
          </view>
          <view class="empty" wx:else>暂未配置选项</view>
        </view>
      </view>
      <view class="form-actions bottom-actions">
        <button class="danger" bindtap="onDeleteMenu">删除菜单</button>
        <button class="primary" loading="{{saving}}" bindtap="onSubmit">保存菜单</button>
      </view>
    </view>
  </scroll-view>
  
  <!-- 固定tabbar区域 -->
  <view class="tabbar-container">
    <admin-tabbar active-key="menuSettings" bind:change="onTabChange"></admin-tabbar>
  </view>
</view>
