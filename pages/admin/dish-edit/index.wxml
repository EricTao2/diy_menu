<view class="page {{themeClass}}">
  <view wx:if="{{errorVisible}}" class="error-toast-mask" bindtap="hideError" catchtouchmove="stopErrorDismiss">
    <view class="error-toast" catchtap="stopErrorDismiss">
      <view class="error-toast__icon">!</view>
      <text class="error-toast__text">{{errorMessage}}</text>
    </view>
  </view>
  <scroll-view class="page-content" scroll-y enable-flex>
    <view class="page-inner page-inner--with-footer {{transitionClass}}">
      <view class="top-bar">
        <text class="page-title">{{isEdit ? '编辑菜品' : '创建菜品'}}</text>
      </view>

      <view class="card section-card">
        <view class="section-header">
          <text class="section-title">基础信息</text>
          <text class="section-desc">完善菜品名称、价格与展示信息</text>
        </view>
        <view class="form-field recipe-import-field">
          <label>菜谱</label>
          <view wx:if="{{!form.recipeId}}" class="recipe-inline recipe-inline--empty">
            <button class="btn-import-recipe" bindtap="onSelectRecipe">从菜谱导入</button>
            <text class="recipe-inline__hint">可快速填充菜品名称、描述和主图</text>
          </view>
          <view wx:else class="recipe-inline recipe-inline--linked">
            <view class="recipe-inline__header">
              <text class="recipe-inline__label">已关联菜谱：</text>
              <text wx:if="{{!recipeMissing}}" class="recipe-inline__name">{{recipe ? recipe.name : '加载中...'}}</text>
              <text wx:else class="recipe-inline__name recipe-inline__name--missing">关联的菜谱已删除</text>
            </view>
            <view class="recipe-inline__actions">
              <button
                class="btn-recipe-action {{recipeMissing ? 'btn-recipe-action--disabled' : ''}}"
                size="mini"
                bindtap="onViewRecipe"
                disabled="{{recipeMissing}}"
              >
                查看菜谱
              </button>
              <button class="btn-recipe-action" size="mini" bindtap="onChangeRecipe">
                更换菜谱
              </button>
            </view>
            <text class="recipe-inline__hint" wx:if="{{recipeMissing}}">
              当前关联的菜谱已删除，请重新选择以继续同步菜品信息。
            </text>
          </view>
        </view>
        <view class="form-field">
          <label>所属分类</label>
          <picker mode="selector" range="{{categoryPicker}}" bindchange="onCategoryChange">
            <view class="picker">{{selectedCategoryName || categoryPicker[0]}}</view>
          </picker>
        </view>
        <view class="form-field">
          <label>菜品名称</label>
          <input value="{{form.name}}" data-field="name" bindinput="onInput" placeholder="请输入菜品名称" />
        </view>
        <view class="form-field">
          <label>价格</label>
          <input type="digit" value="{{form.price}}" data-field="price" bindinput="onInput" placeholder="请输入价格" />
        </view>
        <view class="form-field">
          <label>菜品图片</label>
          <view class="image-upload">
            <view class="image-preview" wx:if="{{form.image}}" bindtap="onPreviewImage">
              <image src="{{form.image}}" mode="aspectFill"></image>
              <view class="image-preview__mask">预览</view>
            </view>
            <view class="image-placeholder" wx:elif="{{!imageUploading}}">
              <text>尚未上传图片</text>
            </view>
            <view class="image-actions">
              <button
                class="btn-image"
                type="primary"
                size="mini"
                loading="{{imageUploading}}"
                disabled="{{imageUploading}}"
                bindtap="onChooseImage"
              >{{imageUploading ? '上传中' : '上传图片'}}</button>
              <button
                class="btn-image"
                size="mini"
                bindtap="onPreviewImage"
                wx:if="{{form.image}}"
              >预览</button>
              <button
                class="btn-image btn-image--danger"
                size="mini"
                bindtap="onClearImage"
                wx:if="{{form.image}}"
              >移除</button>
            </view>
            <view class="image-hint">
              建议上传 1:1 或 4:3 的菜品实拍图，大小不超过 10MB。
            </view>
          </view>
        </view>
        <view class="form-field status-row">
          <label>售卖状态</label>
          <view class="status-switch">
            <switch checked="{{form.status}}" bindchange="onSwitchStatus"></switch>
            <text class="status-label">{{form.status ? '上架' : '下架'}}</text>
          </view>
        </view>
        <view class="form-field">
          <label>描述</label>
          <textarea value="{{form.description}}" data-field="description" bindinput="onInput" placeholder="菜品简介"></textarea>
        </view>
        <view class="form-field">
          <label>标签（逗号分隔）</label>
          <input value="{{form.tags}}" data-field="tags" bindinput="onInput" placeholder="示例：新品,推荐" />
        </view>
      </view>

      <view class="card section-card">
        <view class="section-header">
          <text class="section-title">自定义选项</text>
          <text class="section-desc">关联可搭配的选项组，提升点餐体验</text>
        </view>
        <view class="option-list">
          <block wx:if="{{options.length}}">
            <block wx:for="{{options}}" wx:key="id" wx:for-item="option">
              <view class="option-item" data-option-id="{{option.id}}" bindtap="onOptionToggle">
                <checkbox
                  value="{{option.id}}"
                  checked="{{!!optionSelectionMap[option.id]}}"
                  data-option-id="{{option.id}}"
                  catchtap="onOptionToggle"
                ></checkbox>
                <view class="option-content">
                  <text class="option-name">{{option.name}}</text>
                  <text class="option-choice-summary" wx:if="{{option.choiceSummary}}">{{option.choiceSummary}}</text>
                </view>
              </view>
            </block>
          </block>
          <block wx:else>
            <view class="empty">暂未创建自定义选项</view>
          </block>
        </view>
      </view>
    </view>
  </scroll-view>
  <view class="page-footer">
    <button
      wx:if="{{isEdit}}"
      class="danger"
      loading="{{deleting}}"
      bindtap="onDeleteDish"
    >
      删除菜品
    </button>
    <button class="primary" loading="{{saving}}" bindtap="onSubmit">保存菜品</button>
  </view>
</view>
