<view class="page {{themeClass}}">
  <view class="container">
    <view class="role-bar" wx:if="{{roles.length > 1}}">
      <text class="role-bar__label">当前身份</text>
      <role-switcher
        roles="{{roles}}"
        active-role="{{activeRole}}"
        role-labels="{{roleLabels}}"
        bind:switch="onSwitchRole"
      ></role-switcher>
    </view>
    <view class="role-bar" wx:elif="{{roles.length === 1}}">
      <text class="role-bar__label">{{roleLabels[activeRole] || ''}}</text>
    </view>

    <view class="admin-panel" wx:if="{{activeRole === 'admin'}}">
      <view class="admin-title">管理员操作</view>
      <view class="admin-actions">
        <block wx:for="{{adminShortcuts}}" wx:key="url" wx:for-item="shortcut">
          <view class="admin-action" data-url="{{shortcut.url}}" bindtap="onNavigateToShortcut">
            {{shortcut.label}}
          </view>
        </block>
      </view>
    </view>
    <view class="admin-panel" wx:if="{{activeRole === 'chef'}}">
      <view class="admin-title">{{roleLabels.chef}}功能</view>
      <view class="admin-actions">
        <block wx:for="{{chefShortcuts}}" wx:key="url" wx:for-item="shortcut">
          <view class="admin-action" data-url="{{shortcut.url}}" bindtap="onNavigateToShortcut">
            {{shortcut.label}}
          </view>
        </block>
      </view>
    </view>

    <view class="search-area">
      <input
        class="search-input"
        type="text"
        placeholder="搜索菜品或标签"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
        confirm-type="search"
      />
      <button wx:if="{{searchKeyword}}" class="search-clear" size="mini" bindtap="onClearSearch">
        清空
      </button>
    </view>

    <view class="filters">
      <view class="filter-header">
        <text class="filter-title">筛选</text>
        <picker
          mode="selector"
          range="{{sortModes}}"
          range-key="label"
          value="{{activeSortIndex}}"
          bindchange="onSortChange"
        >
          <view class="sort-picker">排序：{{sortModes[activeSortIndex].label}}</view>
        </picker>
      </view>
      <scroll-view class="tag-filter" scroll-x="true" wx:if="{{availableTags.length}}">
        <view
          class="tag-chip {{activeTag === '' ? 'active' : ''}}"
          data-tag=""
          bindtap="onSelectTag"
        >
          全部标签
        </view>
        <view
          wx:for="{{availableTags}}"
          wx:key="*this"
          class="tag-chip {{activeTag === item ? 'active' : ''}}"
          data-tag="{{item}}"
          bindtap="onSelectTag"
        >
          {{item}}
        </view>
      </scroll-view>
    </view>

    <block wx:if="{{displayCategories.length}}">
      <block wx:for="{{displayCategories}}" wx:key="id" wx:for-item="category">
        <view class="category-block">
          <view class="category-header" data-id="{{category.id}}" bindtap="onToggleCategory">
            <text class="category-title">{{category.name}}</text>
            <text class="collapse-action">{{category.collapsed ? '展开' : '收起'}}</text>
          </view>
          <view class="category-body" wx:if="{{!category.collapsed}}">
            <block wx:for="{{category.dishes}}" wx:key="id" wx:for-item="dish">
              <view class="dish-card" data-dish-id="{{dish.id}}" bindtap="onSelectDish">
                <view class="dish-info">
                  <view class="dish-text">
                    <text class="dish-name">{{dish.name}}</text>
                    <text class="dish-desc" wx:if="{{dish.description}}">{{dish.description}}</text>
                  </view>
                  <view class="dish-price">{{dish.priceText}}</view>
                </view>
                <view class="dish-tags" wx:if="{{dish.tags && dish.tags.length}}">
                  <text wx:for="{{dish.tags}}" wx:key="*this" class="tag">{{item}}</text>
                </view>
              </view>
            </block>
          </view>
        </view>
      </block>
    </block>
    <view class="empty-state" wx:elif="{{!hasResults}}">没有符合条件的菜品</view>
  </view>

  <cart-bar
    visible="{{cartSummary.itemCount > 0 && activeRole === 'customer'}}"
    item-count="{{cartSummary.itemCount}}"
    total-price="{{cartSummary.totalPrice}}"
    item-label="件"
    label="去购物车"
    bind:tap="onGoToCart"
  ></cart-bar>

  <view class="modal" wx:if="{{showOptionModal}}">
    <view class="modal-mask" bindtap="onCloseModal"></view>
    <view class="modal-content">
      <view class="modal-header">
        <text>{{selectedDish.name}}</text>
        <text class="modal-price">{{selectedDishPrice}}</text>
      </view>
      <scroll-view scroll-y style="max-height: 600rpx;">
        <view wx:if="{{selectedOptionList.length}}" class="options-area">
          <option-selector
            options="{{selectedOptionList}}"
            value="{{selectedOptions}}"
            bind:change="onOptionChange"
          ></option-selector>
        </view>
        <view class="quantity-row">
          <text>数量</text>
          <input type="number" value="{{quantity}}" bindinput="onQuantityChange" />
        </view>
      </scroll-view>
      <view class="modal-actions">
        <button bindtap="onCloseModal">取消</button>
        <button class="primary" bindtap="onConfirmAdd">确认</button>
      </view>
    </view>
  </view>
</view>
