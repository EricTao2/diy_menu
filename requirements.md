# DIY菜单小程序需求文档

## 1. 项目概述
构建一个支持多用户、多菜单的“DIY菜单”微信小程序，用户可按菜单分配角色进行菜单配置、浏览点餐与订单处理，界面支持多套UI主题切换。

## 2. 用户与角色
- 用户首次进入小程序时，弹窗让用户设置头像、昵称，并提供按钮让用户一键填充自己的微信昵称和头像
- 微信用户可以访问多个菜单。
- 每个菜单内由菜单管理员为用户分配角色：菜单管理员、厨师、顾客。
- 同一用户在不同菜单中的角色互相独立，可以在单个菜单内拥有多种角色并自由切换。

## 3. 核心功能
### 3.1 菜单选择
- 顶部是用户区域，显示用户的头像、昵称，并提供编辑按钮，弹窗允许用户修改，弹窗右上角要有关闭按钮。
- 下方是菜单选择区域，首先是"新建菜单"的按钮，允许用户创建菜单，用户创建菜单后默认拥有菜单管理员的角色。其次列出用户的所有菜单，用户如果在某菜单内拥有一个角色，则可以在菜单选择页面看到这个菜单
- 菜单选择交互：
  - 点击菜单卡片（角色tag区域外）：选中该菜单，默认选中第一个角色
  - 点击当前选中菜单的角色tag：切换到该角色，菜单保持选中状态
  - 点击非选中菜单的角色tag：切换到该菜单，并直接选中点击的角色tag
- 用户在选择菜单与角色后，可以点击以特定角色进入菜单页面

### 3.2 个人中心

#### 3.2.1 入口与导航
- 在菜单选择页面的用户信息卡片中，原有的"编辑"按钮旁边增加"个人中心"按钮
- 两个按钮横向并排显示，样式保持一致
- 点击"个人中心"按钮跳转到个人中心页面

#### 3.2.2 个人中心页面
- 个人中心页面采用底部tabbar结构，包含两个tab页：我的菜谱、我的原材料
- tabbar固定在底部，用户可自由切换

#### 3.2.3 我的菜谱
- **页面布局**：
  - 顶部区域：搜索框 + "新建菜谱"按钮
  - 中间区域：菜谱列表（可滚动）
  
- **搜索功能**：
  - 搜索框支持菜谱名称子串匹配
  - 前端实时过滤，一次性加载用户所有菜谱数据
  
- **列表展示**：
  - 单个菜谱卡片采用上下布局：
    - 封面图占满卡片宽度（高度 320rpx），无则显示占位图
    - 图片下方显示菜谱名称和创建时间
  - 创建时间显示格式：
    - 1分钟内：显示"刚刚"
    - 1-59分钟：显示"X分钟前"
    - 1-23小时：显示"X小时前"
    - 1-7天：显示"X天前"
    - 超过7天：显示完整日期时间（如"2024-01-15 14:30"）
  - 默认按创建时间倒序排列
  - 卡片整体可点击，不显示操作按钮
  
- **交互操作**：
  - 点击菜谱卡片：进入菜谱详情页
  - 编辑和删除操作统一在详情页进行

#### 3.2.4 菜谱编辑页面
- **页面标题**：创建时显示"新建菜谱"，编辑时显示"编辑菜谱"

- **菜谱基本信息区域**：
  - 名称：文本输入框（必填）
  - 封面图：图片上传组件（选填），支持点击更换
  - 制作说明：多行文本输入框（选填，纯文本）
  
- **原材料清单区域**：
  - 区域标题："原材料清单"
  - 已添加的原材料列表，每项显示：
    - 原材料图片（如有，小尺寸缩略图）
    - 原材料名称
    - 数量 + 单位（如"500 克"）
    - 右侧删除按钮（可移除该原材料）
  - "添加原材料"按钮：点击后跳转到原材料选择页面
  - 原材料选择页面：
    - 列出用户的所有原材料
    - 支持搜索
    - 选择原材料后，弹窗输入数量（必填，数字类型）
    - 确认后添加到原材料清单
  - 原材料以快照形式存储：`[{ingredientId, name, quantity, unit, image}]`
  
- **页面底部操作栏**：
  - "保存菜谱"按钮（主按钮样式）
  - 如果是编辑已有菜谱，增加"删除菜谱"按钮（次要按钮样式）
  - 点击"删除菜谱"弹窗二次确认

#### 3.2.5 菜谱详情页（只读）
- **页面内容**：
  - 菜谱封面图（如有，大图展示）
  - 菜谱名称（大标题）
  - 创建者信息区域：头像 + 昵称
  - 制作说明区域（如有内容才显示）
  - 原材料清单区域（如有原材料才显示）：
    - 按原材料名称聚合显示
    - 每个原材料名称作为一项，下方缩进列出该原材料的所有数量+单位组合
    - 展示格式示例：
      ```
      原材料名称1（显示图片，如有）
          数量1 单位1
          数量2 单位2
      原材料名称2（显示图片，如有）
          数量3 单位3
      ```
    - 如果同一原材料有多条记录（名称相同但单位不同），合并为一个原材料项，下方列出所有数量+单位
    
- **页面操作（仅菜谱创建者可见）**：
  - 页面底部固定操作栏，包含两个按钮：
    - "删除菜谱"按钮（红色警告样式）：点击弹窗二次确认
    - "编辑菜谱"按钮（蓝色主按钮样式）：点击进入菜谱编辑页面
  - **权限控制**：
    - 只有菜谱创建者（userId 匹配）才能看到操作按钮
    - 其他用户（如通过菜品查看菜谱）只能查看，无操作权限
  - 删除成功后自动返回上一页

#### 3.2.6 我的原材料
- **页面布局**：
  - 顶部区域：搜索框 + "新建原材料"按钮
  - 中间区域：原材料列表（可滚动）
  
- **搜索功能**：
  - 搜索框支持原材料名称子串匹配
  - 前端实时过滤，一次性加载用户所有原材料数据
  
- **列表展示**：
  - 单个原材料卡片展示：图片（如有，无则显示占位图）、名称、单位、备注（如有）
  - 默认按创建时间倒序排列
  - 每个原材料卡片右侧有"编辑"、"删除"两个操作按钮
  
- **交互操作**：
  - 点击"编辑"按钮：进入原材料编辑页面
  - 点击"删除"按钮：弹窗二次确认，确认后删除原材料
  - 允许删除已被菜谱使用的原材料（因为菜谱中存储的是快照数据）

#### 3.2.7 原材料编辑页面
- **页面标题**：创建时显示"新建原材料"，编辑时显示"编辑原材料"

- **原材料信息**：
  - 名称：文本输入框（必填）
  - 单位：文本输入框（必填，默认值为"份"）
  - 图片：图片上传组件（选填），支持点击更换
  - 备注：多行文本输入框（选填）
  
- **页面底部操作栏**：
  - "保存原材料"按钮（主按钮样式）
  - 如果是编辑已有原材料，增加"删除原材料"按钮（次要按钮样式）
  - 点击"删除原材料"弹窗二次确认

#### 3.2.8 菜品关联菜谱

##### 3.2.8.1 菜品编辑页面调整
- 在菜品编辑页面的基本信息区域后，新增"关联菜谱"区域

- **未关联菜谱时**：
  - 显示"从菜谱导入"按钮
  - 点击后跳转到菜谱选择页面：
    - 列出用户的所有菜谱（卡片形式）
    - 顶部提供搜索框，支持名称子串匹配
    - 点击某个菜谱卡片后返回菜品编辑页面
  - 选择菜谱后自动执行：
    - 自动填充菜品名称（如原本为空）
    - 自动填充菜品描述（合并或替换原有描述）
    - 自动填充菜品主图（如原本为空）
    - 记录菜谱ID，建立引用关联
  - 填充后的字段用户可以继续手动修改

- **已关联菜谱时**：
  - 显示当前关联的菜谱信息：
    - 如果菜谱存在：显示菜谱名称和缩略图
    - 如果菜谱已被删除：显示"关联的菜谱已删除"提示文字
  - 提供两个操作按钮：
    - "查看菜谱"按钮：跳转到菜谱详情页（只读模式）。如果菜谱已删除，按钮置灰不可点击
    - "更换菜谱"按钮：重新跳转到菜谱选择页面，选择后更新关联并重新填充信息

##### 3.2.8.2 菜品列表展示调整（管理员、厨师视图）
- 在菜单管理页面的菜品卡片上，如果菜品关联了菜谱，显示"有菜谱"标识
- 标识形式：小图标（如书本图标）或tag标签
- 仅管理员和厨师可见此标识，顾客不可见

##### 3.2.8.3 菜品详情页调整
- **管理员、厨师视图**：
  - 如果菜品关联了菜谱且菜谱存在，显示"查看菜谱"按钮
  - 点击后跳转到菜谱详情页（只读模式）
  - 如果菜谱已被删除，不显示此按钮
  
- **顾客视图**：
  - 不显示任何菜谱相关信息
  - 不显示"有菜谱"标识
  - 不显示"查看菜谱"按钮
  - 不显示原材料清单

#### 3.2.9 菜谱更新机制
- 菜品通过 `recipeId` 字段引用菜谱（引用模式，非快照）
- 当用户更新菜谱内容后，所有关联该菜谱的菜品自动同步最新菜谱内容
- 静默更新，无需通知管理员，下次查看时自动显示最新内容
- 如果菜谱被删除：
  - 菜品保留 `recipeId` 字段值
  - 展示时检测菜谱是否存在，不存在则显示"菜谱已删除"
  - 菜品的其他信息（名称、描述、图片、价格等）不受影响，依然正常展示和使用

### 3.3 菜单页面-管理员视图
- 创建菜单时自动生成一个菜品分类："默认分类"
- 菜单页面由多个tab页面构成，用户通过底部tabbar切换页面，分别是:菜单管理、菜单设置、自定义选项库、订单管理

#### 3.3.1 菜单管理
- 页面上方区域第一行是一些功能按钮，有按钮:菜单选择、角色切换（如果用户在该菜单有其他角色才展示）、新增菜品。同一行的按钮样式应该一样，只是位置不同。再下方展示菜单主图（`coverImage`，为空时显示占位图）和菜单描述。
- 页面中间区域为菜品分类和菜品列表
- 菜品分类：支持拖拽方式自定义排序菜品分类；分类单项高度约为基础版本的1.5倍，确保操作区留白充足。
- 菜品列表：展示菜品列表，并可以拖拽排序。点击菜品编辑按钮可进入菜品编辑页面。同一类的菜品列表滑动到末尾后，展示下一个分类的菜品列表，并在一个分类起始时，在菜品列表中用文字标识，方便用户观察到后续菜品是一个新的分类。
- 菜品卡片布局：图片占左侧，右侧信息区垂直排列名称、描述、价格，其中价格需使用不小于32rpx的字体并与卡片底边对齐，底部保留约12rpx的间距；若有描述则显示在价格上方，若无描述也需保持价格贴底。
- 页面滚动交互（使用 `menu-scroll-container` 公共组件）：
  - 初始状态：整页可滚动，用户可查看顶部菜单信息和选菜区域
  - 当用户向下滚动使选菜区域接近顶部时，选菜区域自动固定在顶部（锁定模式），变化过程丝滑无页面跳动
  - 锁定后：左侧分类和右侧菜品列表独立滚动
  - 选菜区域高度固定为视口高度减去底部tabbar高度（安全区通过tabbar的padding处理）
  - 解锁方式：用户向上滚动菜品列表到顶部时自动解除锁定（向下滚动到顶部不解锁）
  - 分类列表与菜品列表滚动联动：用户滚动菜品列表时，高亮分类自动切换为视口底部仍在可见区域内的分类；点击任一分类时，菜品列表平滑跳转到对应分类起始位置（锁定/解锁状态下均需生效）
- 分类列宽度需要可配置，选中态与菜品区域保持同色衔接；右侧操作区统一为圆角图标编辑按钮与放大的拖拽手柄上下排列，整体高度需与菜品图片对齐。
- 菜品编辑页面：维护菜品名称、描述、主图、价格、库存状态、标签、上下架状态、所属分类。菜品仅能归属一个分类。菜品可关联自定义选项并同步更新。页面底部有两个按钮"删除菜品","保存菜品"。

#### 3.3.2 菜单设置
- 编辑菜单的名称、描述、主图、主题、菜品分类。
- 菜品分类的编辑区域列出当前菜单的所有分类，并按照排序顺序列出，对每个分类都可以移动排序和编辑。
- 自定义选项编辑区域：列出现有的所有自定义选项，每个选项下方有"编辑","删除"两个按钮，点击编辑触发选项的编辑功能，点击删除，删除掉这个自定义选项。区域上方有一个"新建选项"的按钮，点击后可以新增自定义选项。每个自定义选项都必须有默认选项。
- 页面底部有两个按钮"删除菜单","保存菜单"

#### 3.3.3 菜单用户
- 可以分享菜单给其他用户，分享方式为小程序卡片分享
- 提供按钮"生成分享链接"，用户点击分享链接后将唤起该小程序，将操作用户添加到该菜单，并授予顾客身份。然后自动进入对应的菜单页面。
- 分页列出当前菜单下的所有用户，一页20条。按照用户身份角色顺序列出：管理员、厨师、顾客。如果用户存在多个角色，也只展示一条数据，但是会在数据行上用类似tag的形式标注用户当前的所有身份。
- 身份管理：每行列出的用户上有编辑按钮，可以新增，删除用户的角色。

#### 3.3.4 菜品订单
- 展示所有顾客在这个菜单中下单的点菜订单

### 3.4 菜单页面-顾客视图
- 菜单页面由多个tab页面构成，用户通过底部tabbar切换页面，分别是:点菜、购物车、订单、通知
- tabbar永远固定在这三个页面的底部，且在最上层不会被覆盖

#### 3.4.1 点菜
- 点菜界面的样式、区域分布、交互基本与管理员页面的菜单管理页面类似
- 页面上方区域第一行是一些功能按钮，有按钮:菜单选择、角色切换（如果用户在该菜单有其他角色才展示）。再下方展示菜单主图（`coverImage`，为空时显示占位图）和菜单描述。
- 页面中间区域为选菜区域，选菜区域分为两个区域，菜品分类和菜品列表。
- 菜品列表：展示菜品列表，单个菜品项展示图片、名称、价格；价格字体不小于32rpx，需与卡片底边对齐并预留约12rpx的下边距，描述（如有）显示在价格上方。卡片右下角放置圆形“+”按钮，样式需与整体主题色一致。用户点击“+”后，如果该菜品没有关联自定义选项，则直接将一份该菜品加入到购物车；如果该菜品关联了自定义选项，则弹窗让用户进行自定义选项的选择（弹窗右上角有关闭按钮，右下方有"加入购物车"按钮）。点击菜品项的卡片其他位置，则打开菜品详情页面，展示菜品的图片、名称、价格、描述。
- 同一类的菜品列表滑动到末尾后，展示下一个分类的菜品列表，并在一个分类起始时，在菜品列表中用文字标识，方便用户观察到后续菜品是一个新的分类。
- 菜品分类：单项高度约为原默认高度的1.5倍，保证触控与可读性；分类列表支持独立滚动。
- 页面滚动交互（使用 `menu-scroll-container` 公共组件）：
  - 初始状态：整页可滚动，用户可查看顶部菜单信息和选菜区域
  - 当用户向下滚动使选菜区域接近顶部时，选菜区域自动固定在顶部（锁定模式），变化过程丝滑无页面跳动
  - 锁定后：左侧分类和右侧菜品列表独立滚动
  - 选菜区域高度固定为视口高度减去底部tabbar高度（安全区通过tabbar的padding处理）
  - 解锁方式：用户向上滚动菜品列表到顶部时自动解除锁定（向下滚动到顶部不解锁）
- 页面底部右下角有按钮："去下单"，用户点击后进入下单页面
- 下单页面：自动将购物车内的菜品添加到下单页面中列出展示，包括菜品图片，名称，价格，下单数量。如果有部分菜品已下架或者被删除(即无效状态)，弹窗提示用户"部分菜品已失效，已自动过滤".页面底部有一个固定在底部的bar，不随页面滚动，bar的左侧为合计金额，右侧为按钮"下单"，用户点击后即创建对应订单。

#### 3.4.2 购物车
- 页面以列表的形式展示用户已加入购物车的菜品和数量
- 已售罄或者已下架的菜品和可下单的菜品分成两个区域展示，可下单的额菜品在上方列出，有分隔栏文字"可下单"。已售罄或者已下架的菜品在下方列出，分隔栏文字为"已下架"，且菜品卡片为渲染为灰色，意在提示用户不可用。

#### 3.4.3 订单
- 顾客可以查看提交的订单列表，单个订单项展示订单状态（已下单→处理中→已完成/已取消）、下单时间、总价。按照提交时间倒序排列，并在订单项的右下角有按钮"取消订单"两个按钮。点击"取消订单"后会弹窗再次让用户确认是否取消，确认后将取消订单。
- 点击单个订单项可以进入订单详情页面，展示订单所有信息，包括：订单编号、订单状态、以菜品列表的方式展示所有下单菜品项（含菜品图片、价格快照、选项快照、下单数量）、下单时间、总价、顾客备注。总价应该显示在页面底部。同时应附带最近的订单操作者。
- 顾客可查看历史订单并支持一键将订单内的菜品再次加入购物车（过滤掉已下架已售罄的彩屏）。

#### 3.4.4 通知
- 通知页面展示用户所有通知，并通过懒加载的方式，仅在用户即将看到时再查询展示下一页的通知。
- 顾客下单、订单状态改变时，发送通知触达所有厨师。
- 点击通知能跳转到相关订单详情页。
- 通过10秒轮询一次来查询自己的消息通知，并在tabbar的通知栏上展示未读通知数量。

### 3.5 菜单页面-厨师视图
- 菜单页面由多个tab页面构成，分别是:点菜订单、点菜通知

#### 3.5.1 订单
- 可以查看顾客提交的点菜订单，订单包含编号、状态（已下单→处理中→已完成/已取消）、时间、总价、菜品项（含选项快照）、顾客备注。按照提交时间倒序排列。
- 厨师可以接单状态为"已下单"的订单，接单后的订单状态变为"处理中"。也可以对"处理中"的订单进行完成操作，订单状态变为"已完成"

#### 3.5.2 通知
- 通知页面展示用户所有通知，并通过懒加载的方式，仅在用户即将看到时再查询展示下一页的通知。
- 厨师操作导致订单状态改变时，发送通知触达订单的创建顾客。
- 点击通知能跳转到相关订单详情页。
- 通过10秒轮询一次来查询自己的消息通知，并在tabbar的通知栏上展示未读通知数量。


## 4. 数据模型与规则

### 4.1 核心数据实体
- **用户**：记录微信身份及各菜单对应的角色列表。
- **菜单**：包含名称、描述、主图（`coverImage`）、主题、自定义选项库、关联分类与菜品。
- **分类**：关联菜单，包含名称、排序权重。
- **菜品**：关联分类和自定义选项集合，包含描述、价格、库存等。可关联菜谱（`recipeId`，选填）。
- **自定义选项**：菜单级定义，含选项名、选项项列表、默认值。
- **购物车**：按用户与菜单存储，记录菜品、数量、选项组合。
- **订单**：基础信息（编号、时间、状态、支付情况）、菜品项列表（含选项快照）、备注、处理记录。
- **通知**：记录通知类型、接收角色、触发事件、发送状态。

### 4.2 新增数据实体（菜谱系统）
- **菜谱（recipes）**：用户级资源，包含：
  - 基本信息：名称（必填）、封面图（选填）、制作说明（选填，纯文本）
  - 原材料清单：以快照形式存储，格式 `[{ingredientId, name, quantity, unit, image}]`
  - 创建者：`userId`
  - 时间戳：`createdAt`、`updatedAt`

- **原材料（ingredients）**：用户级资源，包含：
  - 名称（必填）
  - 单位（必填，默认"份"）
  - 图片（选填）
  - 备注（选填）
  - 创建者：`userId`
  - 时间戳：`createdAt`、`updatedAt`

### 4.3 数据关联关系
- **菜品 ← 菜谱**：菜品通过 `recipeId` 引用菜谱（引用模式），菜谱更新后菜品自动同步最新内容
- **菜谱 → 原材料**：菜谱中的原材料以快照形式存储，删除原材料不影响已有菜谱
- **用户 → 菜谱**：用户创建和管理自己的菜谱，可跨菜单复用
- **用户 → 原材料**：用户创建和管理自己的原材料，可在多个菜谱中使用

### 4.4 业务规则
- 分类与菜品在单菜单内标识唯一；菜品仅属于一个分类；自定义选项在菜单内可复用。
- 菜谱和原材料都是用户级资源，用户只能管理自己的菜谱和原材料。
- 菜谱采用引用模式，修改菜谱后所有关联的菜品自动同步最新内容。
- 菜谱中的原材料采用快照模式，删除原材料不影响已有菜谱。
- 允许删除被菜品关联的菜谱，删除后菜品保留菜谱ID但标记为"菜谱已删除"。
- 顾客角色完全不可见菜谱相关信息，仅管理员和厨师可查看。

## 5. 权限控制
- **菜单管理员**：菜单、分类、菜品、角色管理，通知设置。可管理自己的菜谱和原材料，可在菜品中关联自己的菜谱，可查看菜品关联的菜谱详情。
- **厨师**：查看订单、更新状态、管理处理备注。可查看菜品关联的菜谱详情（如果菜品有关联菜谱）。
- **顾客**：浏览菜单、管理购物车、提交订单、查看并复用历史订单。不可见任何菜谱相关信息。
- **个人中心**：所有用户可管理自己的菜谱和原材料，不受角色限制。
- **菜谱操作权限**：
  - 只有菜谱创建者可以编辑和删除自己的菜谱
  - 其他用户通过菜品关联查看菜谱时，只能查看不能操作
  - 权限判断基于 `recipe.userId === currentUser.id`

## 6. 关键实现细节

### 6.1 个人中心页面数据更新
- 个人中心使用自定义 `createPage` 工具，不支持 `computed` 属性
- 必须手动维护 `filteredRecipes` 和 `filteredIngredients` 数据
- 在以下时机调用更新方法：
  - 数据加载完成后（`loadRecipes`/`loadIngredients`）
  - 搜索输入变化时（`onRecipeSearchInput`/`onIngredientSearchInput`）
- 需要同时在 `onLoad` 和 `onShow` 生命周期加载数据，确保返回时数据刷新

### 6.2 时间显示格式化
- 采用相对时间显示提升用户体验
- 实现 `formatRelativeTime` 函数处理时间转换
- 在前端数据更新时统一格式化（`updateFilteredRecipes`）
- 确保所有展示时间的地方使用 `createdAtText` 而非原始 `createdAt`

### 6.3 菜谱详情页权限判断
- 页面加载时先获取当前用户信息（`getCurrentUser`）
- 加载菜谱后比对 `recipe.userId` 和 `currentUserId`
- 设置 `isOwner` 标志控制操作按钮显示
- 使用 `wx:if="{{isOwner}}"` 条件渲染编辑删除按钮

### 6.4 菜谱列表卡片布局
- 采用上下布局（`flex-direction: column`）
- 封面图使用 `width: 100%` 占满宽度，固定高度 400rpx
- 卡片使用 `overflow: hidden` 让图片无缝贴边
- 卡片整体可点击，无独立操作按钮
- 所有操作集中在详情页底部

### 6.5 原材料聚合显示
- 在 `aggregateIngredients` 方法中按名称分组
- 使用对象存储分组结果：`grouped[name] = { name, image, amounts: [] }`
- 相同名称的原材料合并，保留所有数量+单位组合
- 使用第一条记录的图片作为展示图片
- 前端处理，不依赖后端聚合

## 7. 非功能需求
- 性能与体验：界面交互流畅，常见机型流畅运行。
