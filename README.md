# DIY 菜单小程序

DIY 菜单是一款基于 **微信云开发（CloudBase）** 的多角色共享菜单小程序。系统涵盖菜单管理员、厨师、顾客三类角色，支持在同一账号下跨菜单切换身份，覆盖菜单配置、点餐、订单履约与站内通知等完整业务流程。

> 当前默认接入云函数与云数据库；如需离线演示，可在配置中开启本地 Mock 数据（见下文“运行与配置”）。

---

## 功能特性

- **多菜单 & 多角色**
  - 支持一个用户在多个菜单中拥有不同角色，并在菜单选择页快速切换。
  - 菜单管理员可邀请或分配其他用户的角色。

- **菜单管理工作台**
  - 左侧分类 / 右侧菜品双列布局，支持拖拽排序、菜品编辑、快捷上下架。
  - 采用“整页锁定 + 内部滚动”交互：滚动到选菜区域后自动锁住整页，仅分类/菜品列滚动；任一列滚动回顶部继续上拉可无缝解锁整页；锁定时区域高度自动匹配视口，无额外空白。
  - 菜品支持关联菜单级自定义选项（如辣度、份量），统一管理选项库。

- **顾客点餐体验**
  - 分类浏览、菜品详情、选项选择、加入购物车。
  - 购物车区分可下单与已失效菜品；下单时自动过滤失效项并提示。
  - 订单中心可查看历史订单、再次下单。

- **厨师工作台**
  - 订单按状态分组展示，可查看详情并更新为处理中 / 完成 / 取消。
  - 支持填写处理备注，变化同步通知相关角色。

- **通知与主题**
  - 订单创建、状态变更触发站内通知，仪表盘统一展示。
  - 支持多主题切换，自定义主题对菜单或用户生效。

- **数据与云函数**
  - 云函数统一封装菜单、分类、菜品、订单、通知、角色分配等操作。
  - 返回文档时自动映射 MongoDB `_id` → `id`，前端统一使用 `id`，查询与索引仍基于 `_id`。

---

## 目录结构

```
.
├── app.js                # 小程序入口，初始化云开发、全局状态、主题、通知
├── services/
│   ├── api.js            # API 聚合层，按配置切换 mock / cloud 实现
│   ├── cloud.js          # 云函数调用封装
│   └── mock.js           # 本地 Mock 数据实现
├── cloudfunctions/
│   └── admin/            # 云函数：菜单、角色、分类、菜品、订单、通知等
├── pages/
│   ├── menu-selector/    # 菜单 & 角色选择
│   ├── admin/            # 管理端：菜单工作台、设置、分类、菜品、选项库、用户
│   ├── customer/         # 顾客端：点菜、购物车、订单、历史订单
│   ├── chef/             # 厨师端：订单列表、订单详情
│   └── common/           # 通用订单详情
├── components/           # 角色切换、菜品卡片、选项选择、通知等通用组件
├── utils/                # 权限、主题、格式化、全局事件等工具
├── config/               # 配置开关（云环境、Mock、特性开关）
└── README.md
```

---

## 运行与配置

### 1. 安装依赖

```bash
npm install
# 或使用 yarn / pnpm
```

### 2. 构建 npm

在微信开发者工具中选择 **工具 → 构建 npm**。

### 3. 导入项目

使用微信开发者工具导入本仓库所在目录，即可启动小程序调试。

### 4. 云环境配置

默认启用云函数与云数据库（见 `config/index.js`）：

```js
export const cloudbaseConfig = {
  useMock: false,
  envId: 'your-cloud-env-id',
};
```

- 若需快速离线演示，可将 `cloudbaseConfig.useMock` 置为 `true`，此时 `services/mock.js` 将提供全部数据操作。
- `appConfig.enableMock` 也可控制是否自动注入 Mock 数据（适用于首次本地体验）。

### 5. 初始化数据

- **真实云数据**：首次启动时，云函数会根据登录用户自动初始化默认菜单、分类、菜品等演示数据。
- **Mock 模式**：调用 `services/mock.bootstrapMockData()` 或在开发者工具中清除 Storage 后重启，即可重置演示数据。

---

## 关键技术说明

- **滚动锁定交互**
  - 使用 `IntersectionObserver` 监听“哨兵”节点，判断何时锁定整页滚动。
  - 锁定后通过测量视口高度（包含自定义 tabbar 与安全区域偏移）设置选菜区域高度。
  - 利用手势桥接逻辑，在内层 `scroll-view` 顶部继续上拉时，解除锁定并让整页滚动，保证体验连贯。

- **云函数数据处理**
  - 云函数 `admin` 集中处理菜单、分类、菜品、订单、角色、通知等业务，并进行权限校验。
  - `normalizeDoc` 负责保证返回文档带有 `id` 字段，同时保留 MongoDB `_id` 以便数据库层使用索引。

- **排序与拖拽**
  - 分类/菜品拖拽后，前端维护临时顺序并调用 `sortCategories` / `sortDishes` 持久化 `sortOrder`。
  - 更新失败时自动回滚并提示用户。

---

## 常见命令

| 命令 | 说明 |
| --- | --- |
| `npm run lint` | 代码风格检查（若配置） |
| `npm run clean` | 清理构建产物（按需自定义） |

> 小程序不提供原生 CLI 启动命令，调试、真机预览、云开发控制台操作需在微信开发者工具中完成。

---

## 贡献指南

1. Fork 仓库并创建功能分支。
2. 新增或修改云函数时，请同步更新 `technical_design.md` 中的 API 说明。
3. 对需求或交互的调整，请同时更新 `requirements.md` 与本文。
4. 提交 PR 前，请在真实云环境与 Mock 模式下各自确认关键流程（菜单管理、点餐、订单处理）无异常。

---

## 许可证

本项目使用 MIT 许可证，详见 [LICENSE](LICENSE)。
